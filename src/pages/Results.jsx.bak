function Results({ appData, updateAppData }) {
  const { winners, prizes, employees } = appData

  const exportToCSV = () => {
    if (winners.length === 0) {
      alert('æ²¡æœ‰ä¸­å¥–è®°å½•å¯ä»¥å¯¼å‡º')
      return
    }

    const headers = ['åºå·', 'å§“å', 'å·¥å·', 'å¥–é¡¹', 'ç­‰çº§', 'ä¸­å¥–æ—¶é—´']
    const rows = winners.map((winner, index) => [
      index + 1,
      winner.employeeName,
      winner.employeeId,
      winner.prizeName,
      winner.prizeLevel,
      new Date(winner.timestamp).toLocaleString('zh-CN')
    ])

    const csvContent = [
      headers.join(','),
      ...rows.map(row => row.map(cell => `"${cell}"`).join(','))
    ].join('\n')

    const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' })
    const link = document.createElement('a')
    const url = URL.createObjectURL(blob)

    link.setAttribute('href', url)
    link.setAttribute('download', `ä¸­å¥–åå•_${new Date().toLocaleDateString('zh-CN')}.csv`)
    link.style.visibility = 'hidden'

    document.body.appendChild(link)
    link.click()
    document.body.removeChild(link)
  }

  const exportToTXT = () => {
    if (winners.length === 0) {
      alert('æ²¡æœ‰ä¸­å¥–è®°å½•å¯ä»¥å¯¼å‡º')
      return
    }

    let content = 'å¹´ä¼šæŠ½å¥–ä¸­å¥–åå•\n'
    content += '=' .repeat(50) + '\n\n'

    const sortedPrizes = [...prizes].sort((a, b) => b.level - a.level)

  return (
    <div className="fade-in">
      <div className="card">
        <div className="flex-between">
          <h2 className="subheading">ğŸ† ä¸­å¥–åå•</h2>
          <div className="flex-gap">
            <button onClick={exportToCSV} className="button button-primary" disabled={winners.length === 0}>
              ğŸ“„ å¯¼å‡ºCSV
            </button>
            <button onClick={exportToTXT} className="button button-secondary" disabled={winners.length === 0}>
              ğŸ“ å¯¼å‡ºTXT
            </button>
            {winners.length > 0 && (
              <button onClick={resetWinners} className="button button-danger">
                ğŸ—‘ï¸ æ¸…ç©ºè®°å½•
              </button>
            )}
          </div>
        </div>
      </div>

      {winners.length === 0 ? (
        <div className="card">
          <p className="text" style={{ textAlign: 'center', padding: '40px' }}>
            è¿˜æ²¡æœ‰ä¸­å¥–è®°å½•ï¼Œ<Link to="/lottery">å¼€å§‹æŠ½å¥–</Link>
          </p>
        </div>
      ) : (
        <div className="grid-2">
          <div className="card">
            <h3 className="subheading">æŒ‰å¥–é¡¹åˆ†ç»„</h3>

            {sortedPrizes.map((prize, index) => {
              const prizeWinners = winners.filter(w => w.prizeLevel === prize.level)

              return (
                <div key={index} className="card mt-4" style={{ background: '#f7fafc' }}>
                  <div className="flex-between">
                    <div>
                      <strong>{prize.name}</strong>
                      <span className="text-small">ï¼ˆç­‰çº§ {prize.level}ï¼‰</span>
                    </div>
                    <div className="text-small">
                      {prizeWinners.length} / {prize.count}
                    </div>
                  </div>

                  {prizeWinners.length === 0 ? (
                    <p className="text-small mt-4">æš‚æ— ä¸­å¥–äººå‘˜</p>
                  ) : (
                    <table className="table mt-4">
                      <thead>
                        <tr>
                          <th>åºå·</th>
                          <th>å§“å</th>
                          <th>å·¥å·</th>
                        </tr>
                      </thead>
                      <tbody>
                        {prizeWinners.map((winner, winnerIndex) => (
                          <tr key={winnerIndex}>
                            <td>{winnerIndex + 1}</td>
                            <td>{winner.employeeName}</td>
                            <td>{winner.employeeId}</td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  )}
                </div>
              )
            })}
          </div>

          <div className="card">
            <h3 className="subheading">å®Œæ•´ä¸­å¥–åˆ—è¡¨</h3>

            <div style={{ maxHeight: '600px', overflow: 'auto' }}>
              <table className="table">
                <thead style={{ position: 'sticky', top: 0, background: 'white', zIndex: 1 }}>
                  <tr>
                    <th>åºå·</th>
                    <th>å§“å</th>
                    <th>å·¥å·</th>
                    <th>å¥–é¡¹</th>
                    <th>ç­‰çº§</th>
                  </tr>
                </thead>
                <tbody>
                  {winners.map((winner, index) => (
                    <tr key={index}>
                      <td>{index + 1}</td>
                      <td><strong>{winner.employeeName}</strong></td>
                      <td>{winner.employeeId}</td>
                      <td>{winner.prizeName}</td>
                      <td>{winner.prizeLevel}</td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      )}

      {winners.length > 0 && (
        <div className="card mt-4">
          <h3 className="subheading">ğŸ“Š ç»Ÿè®¡ä¿¡æ¯</h3>

          <div className="grid-3">
            <div className="card" style={{ background: '#f7fafc' }}>
              <div className="text-small">å‚ä¸æ€»äººæ•°</div>
              <div style={{ fontSize: '32px', fontWeight: 'bold', color: '#667eea' }}>
                {employees.length}
              </div>
            </div>

            <div className="card" style={{ background: '#f7fafc' }}>
              <div className="text-small">ä¸­å¥–äººæ•°</div>
              <div style={{ fontSize: '32px', fontWeight: 'bold', color: '#48bb78' }}>
                {winners.length}
              </div>
            </div>

            <div className="card" style={{ background: '#f7fafc' }}>
              <div className="text-small">ä¸­å¥–ç‡</div>
              <div style={{ fontSize: '32px', fontWeight: 'bold', color: '#ed8936' }}>
                {((winners.length / employees.length) * 100).toFixed(1)}%
              </div>
            </div>
          </div>

          <div className="card mt-4" style={{ background: '#f7fafc' }}>
            <h4 className="subheading">å¥–é¡¹åˆ†å¸ƒ</h4>
            <table className="table">
              <thead>
                <tr>
                  <th>å¥–é¡¹</th>
                  <th>ç­‰çº§</th>
                  <th>ä¸­å¥–äººæ•°</th>
                  <th>å®Œæˆåº¦</th>
                </tr>
              </thead>
              <tbody>
                {sortedPrizes.map((prize, index) => {
                  const prizeWinners = winners.filter(w => w.prizeLevel === prize.level)
                  const percentage = (prizeWinners.length / prize.count) * 100

                  return (
                    <tr key={index}>
                      <td>{prize.name}</td>
                      <td>{prize.level}</td>
                      <td>{prizeWinners.length}</td>
                      <td>
                        <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                          <div style={{
                            flex: 1,
                            height: '8px',
                            background: '#e2e8f0',
                            borderRadius: '4px',
                            overflow: 'hidden',
                            minWidth: '100px'
                          }}>
                            <div style={{
                              width: `${Math.min(percentage, 100)}%`,
                              height: '100%',
                              background: percentage >= 100 ? '#48bb78' : '#667eea'
                            }} />
                          </div>
                          <span className="text-small">{percentage.toFixed(0)}%</span>
                        </div>
                      </td>
                    </tr>
                  )
                })}
              </tbody>
            </table>
          </div>
        </div>
      )}
    </div>
  )
}

export default Results
